<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Confer√™ncia Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #2563eb;
            --success: #10b981;
            --bg: #f3f4f6;
            --card: #ffffff;
            --text-main: #1f2937;
            --text-sec: #6b7280;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: 'Inter', sans-serif; 
            margin: 0; 
            padding: 0; 
            background: var(--bg); 
            /* Fix para iOS Safari (altura din√¢mica) */
            height: 100vh;
            height: 100dvh; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden;
        }

        /* Header Fixo */
        header {
            background: var(--card);
            padding: 15px 20px;
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
            flex-shrink: 0;
        }
        header h1 { margin: 0; font-size: 1.2rem; color: var(--text-main); font-weight: 700; }
        .btn-history {
            background: none; border: none; color: var(--primary); font-weight: 600; cursor: pointer; font-size: 0.9rem;
        }

        /* Container Principal */
        main { flex: 1; position: relative; overflow-y: auto; padding: 20px; -webkit-overflow-scrolling: touch; }

        /* Telas */
        .screen { 
            display: none; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            min-height: 100%; 
            animation: fadeIn 0.3s ease-out;
        }
        .active { display: flex; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Cart√µes */
        .card {
            background: var(--card);
            padding: 25px;
            border-radius: 16px;
            box-shadow: var(--shadow);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        h2 { color: var(--text-main); margin: 0 0 10px 0; font-size: 1.5rem; }
        p { color: var(--text-sec); margin-bottom: 20px; line-height: 1.5; }

        /* Scanner Customizado */
        #scanner-wrapper {
            width: 100%;
            max-width: 400px;
            border-radius: 16px;
            overflow: hidden;
            position: relative;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            background: #000;
            /* Garante altura m√≠nima para o v√≠deo n√£o colapsar */
            min-height: 300px; 
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #reader { width: 100%; height: 100%; }
        
        /* Oculta elementos padr√£o feios da lib */
        #reader__dashboard_section_csr button { display: none !important; } 

        /* Moldura de Foco */
        .scan-overlay {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 70%; padding-bottom: 70%; /* Quadrado responsivo */
            border: 2px solid rgba(255,255,255,0.7);
            border-radius: 12px;
            box-shadow: 0 0 0 9999px rgba(0,0,0,0.5);
            z-index: 10;
            pointer-events: none;
        }
        .scan-label {
            position: absolute; bottom: 20px; left: 0; right: 0;
            text-align: center; color: white; font-weight: 600; font-size: 1.1rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.8);
            z-index: 20;
        }

        /* Bot√µes */
        .btn-action {
            background: var(--primary);
            color: white;
            padding: 16px 32px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 1rem;
            border: none;
            width: 100%;
            cursor: pointer;
            transition: transform 0.1s;
            margin-top: 15px;
        }
        .btn-action:active { transform: scale(0.98); }
        .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); }

        /* Relat√≥rio */
        .report-row {
            display: flex; justify-content: space-between; padding: 12px 0;
            border-bottom: 1px solid #eee;
        }
        .report-row:last-child { border-bottom: none; }
        .lbl { font-size: 0.85rem; color: var(--text-sec); }
        .val { font-weight: 600; color: var(--text-main); word-break: break-all; text-align: right; }

        /* Hist√≥rico Modal */
        #history-view {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg); z-index: 200; padding: 20px;
            overflow-y: auto; display: none;
        }
        .history-item {
            background: var(--card); padding: 15px; border-radius: 12px; margin-bottom: 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); border-left: 4px solid var(--success);
        }
        .history-header { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.8rem; color: var(--text-sec); }
        .badge { background: #d1fae5; color: #065f46; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold;}

        .check-icon {
            width: 80px; height: 80px; background: var(--success); color: white;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 40px; margin: 0 auto 20px;
            box-shadow: 0 10px 20px rgba(16, 185, 129, 0.3);
        }

        .error-box { background: #fee2e2; color: #b91c1c; padding: 15px; border-radius: 8px; font-size: 0.9rem; margin-top: 10px; display: none; }
    </style>
</head>
<body>

    <header>
        <h1>‚úî CheckConfirm</h1>
        <button class="btn-history" onclick="toggleHistory()">Hist√≥rico</button>
    </header>

    <main>
        <div id="screen-loading" class="screen active">
            <div class="card">
                <div style="font-size: 3rem; margin-bottom: 15px;">üîç</div>
                <h2>Aguardando Link</h2>
                <p>Abra o link gerado pelo aplicativo de inser√ß√£o para iniciar.</p>
                <div id="error-msg" class="error-box"></div>
                
                <button id="btn-manual-start" class="btn-action" style="display:none;" onclick="tentarIniciarNovamente()">
                    Iniciar C√¢mera
                </button>
            </div>
        </div>

        <div id="screen-scan" class="screen">
            <h2 style="margin-bottom: 15px; font-size: 1.2rem;">Escaneie o C√≥digo</h2>
            
            <div id="scanner-wrapper">
                <div id="reader"></div>
                <div class="scan-overlay"></div>
                <div class="scan-label">Procurando: <span id="target-name" style="color: #ffd700">...</span></div>
            </div>
            
            <p style="margin-top: 20px; font-size: 0.9rem;">Mantenha o c√≥digo dentro do quadrado.</p>
        </div>

        <div id="screen-success" class="screen">
            <div class="card">
                <div class="check-icon">‚úì</div>
                <h2>Conferido!</h2>
                <p>Valida√ß√£o conclu√≠da com sucesso.</p>
                
                <div id="report-content" style="text-align: left; background: #f9fafb; padding: 15px; border-radius: 8px; margin-bottom: 20px;"></div>
                
                <button class="btn-action btn-outline" onclick="location.href=location.pathname">Nova Confer√™ncia</button>
            </div>
        </div>

        <div id="history-view">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Hist√≥rico Local</h2>
                <button onclick="toggleHistory()" style="background:none; border:none; font-size: 1.5rem;">‚úï</button>
            </div>
            <div id="history-list"></div>
            <p id="empty-history" style="text-align: center; margin-top: 50px; display: none;">Nenhum registro encontrado.</p>
            <button onclick="limparHistorico()" style="width:100%; color: red; background: none; border: none; padding: 20px; margin-top: 20px; opacity: 0.7;">Limpar Hist√≥rico</button>
        </div>
    </main>

    <script>
        // --- CONFIGURA√á√ÉO ---
        let dadosEsperados = null;
        let html5QrcodeScanner = null;
        const ordemChecagem = ['extra', 'comercial', 'popular'];
        let passoAtual = 0;

        // --- INICIALIZA√á√ÉO ---
        window.onload = function() {
            const params = new URLSearchParams(window.location.search);
            const dadosCriptografados = params.get('data');

            if (dadosCriptografados) {
                processarDadosUrl(dadosCriptografados);
            }
        };

        function processarDadosUrl(encryptedData) {
            try {
                const decryptedBytes = CryptoJS.AES.decrypt(decodeURIComponent(encryptedData), 'chave-mestra-123');
                const textoOriginal = decryptedBytes.toString(CryptoJS.enc.Utf8);
                
                if (!textoOriginal) throw new Error("Falha na descriptografia");
                
                dadosEsperados = JSON.parse(textoOriginal);
                iniciarScanner();

            } catch (error) {
                mostrarErro("Link inv√°lido ou expirado.");
                console.error(error);
            }
        }

        function mostrarErro(msg) {
            const box = document.getElementById('error-msg');
            box.innerText = msg;
            box.style.display = "block";
        }

        function tentarIniciarNovamente() {
            iniciarScanner();
        }

        // --- L√ìGICA DO SCANNER OTIMIZADA PARA IOS ---
        function iniciarScanner() {
            mudarTela('screen-scan');
            passoAtual = 0;
            atualizarInstrucao();

            // Configura√ß√£o espec√≠fica para evitar erros no Safari/iOS
            html5QrcodeScanner = new Html5Qrcode("reader");

            // Define o tamanho da caixa de leitura baseado na largura da tela
            // No iPhone, evita que a caixa seja maior que o v√≠deo
            const width = window.innerWidth > 400 ? 300 : 250;
            
            const config = { 
                fps: 10, 
                qrbox: { width: width, height: width },
                // IMPORTANTE: N√£o use aspectRatio fixo no iOS, deixe a c√¢mera decidir
            };
            
            const cameraConfig = { 
                facingMode: "environment" 
            };

            html5QrcodeScanner.start(cameraConfig, config, onScanSuccess, onScanError)
            .catch(err => {
                console.error("Erro C√¢mera:", err);
                mudarTela('screen-loading');
                mostrarErro("N√£o foi poss√≠vel acessar a c√¢mera. Verifique as permiss√µes do navegador.");
                // Mostra bot√£o manual caso o navegador tenha bloqueado o autoplay
                document.getElementById('btn-manual-start').style.display = 'block';
            });
        }

        function onScanError(errorMessage) {
            // Ignora erros de "n√£o encontrou c√≥digo" para n√£o poluir o console
        }

        function atualizarInstrucao() {
            const labelMap = { 'extra': 'EXTRA', 'comercial': 'COMERCIAL', 'popular': 'POPULAR' };
            const atual = labelMap[ordemChecagem[passoAtual]];
            document.getElementById('target-name').innerText = atual;
        }

        function onScanSuccess(decodedText) {
            const tipoAtual = ordemChecagem[passoAtual];
            const codigoEsperado = dadosEsperados[tipoAtual];

            if (decodedText === codigoEsperado) {
                if (navigator.vibrate) navigator.vibrate(100);
                
                passoAtual++;
                if (passoAtual >= 3) {
                    finalizarConferencia();
                } else {
                    atualizarInstrucao();
                    html5QrcodeScanner.pause();
                    setTimeout(() => html5QrcodeScanner.resume(), 1000);
                }
            }
        }

        function finalizarConferencia() {
            if(html5QrcodeScanner) {
                html5QrcodeScanner.stop().then(() => {
                    salvarNoHistorico();
                    mudarTela('screen-success');
                    renderizarRelatorioFinal();
                }).catch(err => {
                    console.error("Erro ao parar scanner", err);
                    mudarTela('screen-success'); // For√ßa ida para o sucesso mesmo se der erro no stop
                    renderizarRelatorioFinal();
                });
            }
        }

        function renderizarRelatorioFinal() {
            const html = `
                <div class="report-row"><span class="lbl">Extra</span> <span class="val">${dadosEsperados.extra}</span></div>
                <div class="report-row"><span class="lbl">Comercial</span> <span class="val">${dadosEsperados.comercial}</span></div>
                <div class="report-row"><span class="lbl">Popular</span> <span class="val">${dadosEsperados.popular}</span></div>
                <div class="report-row" style="margin-top:10px"><span class="lbl">Status</span> <span class="val" style="color:var(--success)">AUDITADO ‚úî</span></div>
            `;
            document.getElementById('report-content').innerHTML = html;
        }

        // --- GERENCIAMENTO DE TELAS ---
        function mudarTela(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        // --- SISTEMA DE HIST√ìRICO ---
        function salvarNoHistorico() {
            const registro = {
                dataAuditada: new Date().toLocaleString(),
                dados: dadosEsperados
            };

            let historico = JSON.parse(localStorage.getItem('checklist_history') || '[]');
            historico.unshift(registro);
            if (historico.length > 20) historico = historico.slice(0, 20);
            localStorage.setItem('checklist_history', JSON.stringify(historico));
        }

        function toggleHistory() {
            const view = document.getElementById('history-view');
            const isHidden = view.style.display === 'none' || view.style.display === '';
            
            if (isHidden) {
                renderizarHistorico();
                view.style.display = 'block';
            } else {
                view.style.display = 'none';
            }
        }

        function renderizarHistorico() {
            const historico = JSON.parse(localStorage.getItem('checklist_history') || '[]');
            const listaDiv = document.getElementById('history-list');
            const emptyMsg = document.getElementById('empty-history');
            
            listaDiv.innerHTML = '';

            if (historico.length === 0) {
                emptyMsg.style.display = 'block';
                return;
            } else {
                emptyMsg.style.display = 'none';
            }

            historico.forEach(item => {
                const div = document.createElement('div');
                div.className = 'history-item';
                div.innerHTML = `
                    <div class="history-header">
                        <span>üìÖ ${item.dataAuditada}</span>
                        <span class="badge">OK</span>
                    </div>
                    <div style="font-size: 0.9rem; color: #374151;">
                        <strong>E:</strong> ${item.dados.extra} | 
                        <strong>C:</strong> ${item.dados.comercial} | 
                        <strong>P:</strong> ${item.dados.popular}
                    </div>
                `;
                listaDiv.appendChild(div);
            });
        }

        function limparHistorico() {
            if(confirm("Apagar hist√≥rico?")) {
                localStorage.removeItem('checklist_history');
                renderizarHistorico();
            }
        }
    </script>
</body>
</html>