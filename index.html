<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conferência de Checklist</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; background: #f0f2f5; height: 100vh; display: flex; flex-direction: column; }
        
        /* Telas (Estados) */
        .screen { display: none; flex-direction: column; align-items: center; justify-content: center; height: 100%; padding: 20px; text-align: center; }
        .active { display: flex; }

        /* Estilos Gerais */
        h2 { color: #333; margin-bottom: 20px; }
        p { color: #666; font-size: 1.1em; }
        
        /* Botões e Inputs */
        .btn-upload { background: #007bff; color: white; padding: 15px 30px; border-radius: 50px; font-weight: bold; cursor: pointer; display: inline-block; margin-top: 20px; }
        input[type="file"] { display: none; }

        /* Área da Câmera */
        #reader { width: 100%; max-width: 500px; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .status-bar { background: #333; color: #fff; width: 100%; padding: 15px; text-align: center; font-size: 1.2em; font-weight: bold; position: fixed; top: 0; left: 0; z-index: 10; }
        .current-target { color: #ffd700; } /* Dourado para destaque */

        /* Tela de Sucesso */
        #screen-success { background-color: #2ecc71; color: white; }
        #screen-success h1 { font-size: 3em; margin: 0; }
        .report-card { background: rgba(255,255,255,0.2); padding: 20px; border-radius: 10px; margin-top: 20px; text-align: left; width: 100%; max-width: 400px; }
        .report-item { margin: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.3); padding-bottom: 5px; }
        .report-label { font-size: 0.8em; opacity: 0.8; }
        .report-value { font-size: 1.2em; font-weight: bold; }

    </style>
</head>
<body>

    <div id="screen-upload" class="screen active">
        <h2>Conferência de Carga</h2>
        <p>Carregue o arquivo recebido para iniciar a auditoria.</p>
        <label class="btn-upload">
            Selecionar Arquivo .check
            <input type="file" id="fileInput" accept=".check, .txt" onchange="processarArquivo(this)">
        </label>
    </div>

    <div id="screen-scan" class="screen" style="justify-content: flex-start; padding-top: 60px;">
        <div class="status-bar">
            Procurando: <span id="target-name" class="current-target">...</span>
        </div>
        <div id="reader"></div>
        <p id="feedback-msg" style="margin-top: 20px;">Aponte a câmera para o código de barras.</p>
    </div>

    <div id="screen-success" class="screen">
        <h1>✔</h1>
        <h2>CONFERÊNCIA OK</h2>
        <p>Todos os códigos foram validados.</p>
        
        <div class="report-card" id="report-content">
            </div>
        
        <button class="btn-upload" style="background: white; color: #2ecc71; margin-top: 30px;" onclick="location.reload()">Nova Conferência</button>
    </div>

    <script>
        // Variáveis de Estado
        let dadosEsperados = null;
        let html5QrcodeScanner = null;
        const ordemChecagem = ['extra', 'comercial', 'popular'];
        let passoAtual = 0;

        // 1. Processar Arquivo
        function processarArquivo(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    // Tenta descriptografar
                    const bytes = CryptoJS.AES.decrypt(e.target.result, 'chave-mestra-123');
                    const textoOriginal = bytes.toString(CryptoJS.enc.Utf8);
                    
                    if (!textoOriginal) throw new Error("Senha incorreta ou arquivo inválido");
                    
                    dadosEsperados = JSON.parse(textoOriginal);
                    iniciarScanner();
                } catch (error) {
                    alert("Erro ao ler arquivo: Certifique-se que é um arquivo válido gerado pelo sistema.");
                    console.error(error);
                }
            };
            reader.readAsText(file);
        }

        // 2. Iniciar Scanner
        function iniciarScanner() {
            mudarTela('screen-scan');
            passoAtual = 0;
            atualizarInstrucao();

            html5QrcodeScanner = new Html5Qrcode("reader");
            
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            
            // Tenta usar câmera traseira ('environment')
            html5QrcodeScanner.start({ facingMode: "environment" }, config, onScanSuccess)
            .catch(err => {
                alert("Erro ao abrir câmera. Dê permissão ao navegador.");
            });
        }

        // 3. Atualizar UI para dizer o que estamos procurando
        function atualizarInstrucao() {
            const labelMap = {
                'extra': 'CÓD. EXTRA',
                'comercial': 'CÓD. COMERCIAL',
                'popular': 'CÓD. POPULAR'
            };
            document.getElementById('target-name').innerText = labelMap[ordemChecagem[passoAtual]];
        }

        // 4. Lógica de Validação ao Ler Código
        function onScanSuccess(decodedText, decodedResult) {
            const tipoAtual = ordemChecagem[passoAtual]; // ex: 'extra'
            const codigoEsperado = dadosEsperados[tipoAtual];

            if (decodedText === codigoEsperado) {
                // SUCESSO NO PASSO
                alert(`✅ ${tipoAtual.toUpperCase()} Confirmado!`);
                passoAtual++;

                if (passoAtual >= 3) {
                    finalizarConferencia();
                } else {
                    atualizarInstrucao();
                    // Pequena pausa para o usuário não ler o mesmo código duas vezes sem querer
                    html5QrcodeScanner.pause();
                    setTimeout(() => html5QrcodeScanner.resume(), 1000);
                }
            } else {
                // CÓDIGO ERRADO
                console.log(`Lido: ${decodedText} | Esperado: ${codigoEsperado}`);
                // Opcional: Dar feedback visual de erro, mas cuidado para não travar a operação
                document.getElementById('feedback-msg').innerText = "❌ Código incorreto! Tente novamente.";
                document.getElementById('feedback-msg').style.color = "red";
            }
        }

        // 5. Gerar Relatório Final
        function finalizarConferencia() {
            if(html5QrcodeScanner) {
                html5QrcodeScanner.stop().then(() => {
                    mudarTela('screen-success');
                    gerarRelatorioHtml();
                }).catch(err => console.error(err));
            }
        }

        function gerarRelatorioHtml() {
            const html = `
                <div class="report-item">
                    <div class="report-label">Data Criação</div>
                    <div class="report-value">${dadosEsperados.data}</div>
                </div>
                <div class="report-item">
                    <div class="report-label">Extra</div>
                    <div class="report-value">${dadosEsperados.extra}</div>
                </div>
                <div class="report-item">
                    <div class="report-label">Comercial</div>
                    <div class="report-value">${dadosEsperados.comercial}</div>
                </div>
                <div class="report-item">
                    <div class="report-label">Popular</div>
                    <div class="report-value">${dadosEsperados.popular}</div>
                </div>
                <div class="report-item" style="border:none; margin-top:20px;">
                    <div class="report-label">Status</div>
                    <div class="report-value">AUDITADO EM ${new Date().toLocaleTimeString()}</div>
                </div>
            `;
            document.getElementById('report-content').innerHTML = html;
        }

        // Utilitário para trocar de tela
        function mudarTela(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }
    </script>
</body>
</html>