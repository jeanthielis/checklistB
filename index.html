<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conferência de Checklist</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; background: #f0f2f5; height: 100vh; display: flex; flex-direction: column; }
        
        /* Telas (Estados) */
        .screen { display: none; flex-direction: column; align-items: center; justify-content: center; height: 100%; padding: 20px; text-align: center; }
        .active { display: flex; }

        /* Estilos Gerais */
        h2 { color: #333; margin-bottom: 20px; }
        p { color: #666; font-size: 1.1em; }
        
        /* Botões */
        .btn-action { background: #007bff; color: white; padding: 15px 30px; border-radius: 50px; font-weight: bold; cursor: pointer; display: inline-block; margin-top: 20px; border:none; text-decoration: none;}

        /* Área da Câmera */
        #reader { width: 100%; max-width: 500px; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .status-bar { background: #333; color: #fff; width: 100%; padding: 15px; text-align: center; font-size: 1.2em; font-weight: bold; position: fixed; top: 0; left: 0; z-index: 10; }
        .current-target { color: #ffd700; } 

        /* Tela de Sucesso */
        #screen-success { background-color: #2ecc71; color: white; }
        #screen-success h1 { font-size: 3em; margin: 0; }
        .report-card { background: rgba(255,255,255,0.2); padding: 20px; border-radius: 10px; margin-top: 20px; text-align: left; width: 100%; max-width: 400px; }
        .report-item { margin: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.3); padding-bottom: 5px; }
        .report-label { font-size: 0.8em; opacity: 0.8; }
        .report-value { font-size: 1.2em; font-weight: bold; }
        
        .error-msg { color: red; background: #fee; padding: 10px; border-radius: 5px; display: none; }

    </style>
</head>
<body>

    <div id="screen-loading" class="screen active">
        <h2>Aguardando Dados...</h2>
        <p>Acesse este sistema através do link gerado pelo aplicativo de inserção.</p>
        <div id="error-box" class="error-msg"></div>
    </div>

    <div id="screen-scan" class="screen" style="justify-content: flex-start; padding-top: 60px;">
        <div class="status-bar">
            Procurando: <span id="target-name" class="current-target">...</span>
        </div>
        <div id="reader"></div>
        <p id="feedback-msg" style="margin-top: 20px;">Aponte a câmera para o código de barras.</p>
    </div>

    <div id="screen-success" class="screen">
        <h1>✔</h1>
        <h2>CONFERÊNCIA OK</h2>
        <p>Todos os códigos foram validados.</p>
        
        <div class="report-card" id="report-content"></div>
        
        <button class="btn-action" style="background: white; color: #2ecc71; margin-top: 30px;" onclick="location.href=location.pathname">Nova Conferência</button>
    </div>

    <script>
        // Variáveis de Estado
        let dadosEsperados = null;
        let html5QrcodeScanner = null;
        const ordemChecagem = ['extra', 'comercial', 'popular'];
        let passoAtual = 0;

        // Ao carregar a página, verifica se há dados na URL
        window.onload = function() {
            const params = new URLSearchParams(window.location.search);
            const dadosCriptografados = params.get('data');

            if (dadosCriptografados) {
                processarDadosUrl(dadosCriptografados);
            }
        };

        // 1. Processar Dados da URL
        function processarDadosUrl(encryptedData) {
            try {
                // Decodifica URL e Descriptografa
                // Importante: decodeURIComponent é necessário pois a URL transforma caracteres como '+'
                const decryptedBytes = CryptoJS.AES.decrypt(decodeURIComponent(encryptedData), 'chave-mestra-123');
                const textoOriginal = decryptedBytes.toString(CryptoJS.enc.Utf8);
                
                if (!textoOriginal) throw new Error("Senha incorreta ou link corrompido");
                
                dadosEsperados = JSON.parse(textoOriginal);
                iniciarScanner();

            } catch (error) {
                mostrarErro("Link inválido. Peça para gerar novamente.");
                console.error(error);
            }
        }

        function mostrarErro(msg) {
            const box = document.getElementById('error-box');
            box.innerText = msg;
            box.style.display = 'block';
        }

        // 2. Iniciar Scanner
        function iniciarScanner() {
            mudarTela('screen-scan');
            passoAtual = 0;
            atualizarInstrucao();

            html5QrcodeScanner = new Html5Qrcode("reader");
            
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            
            html5QrcodeScanner.start({ facingMode: "environment" }, config, onScanSuccess)
            .catch(err => {
                alert("Erro ao abrir câmera. Verifique as permissões.");
            });
        }

        // 3. Atualizar UI
        function atualizarInstrucao() {
            const labelMap = {
                'extra': 'CÓD. EXTRA',
                'comercial': 'CÓD. COMERCIAL',
                'popular': 'CÓD. POPULAR'
            };
            document.getElementById('target-name').innerText = labelMap[ordemChecagem[passoAtual]];
        }

        // 4. Lógica de Validação
        function onScanSuccess(decodedText, decodedResult) {
            const tipoAtual = ordemChecagem[passoAtual];
            const codigoEsperado = dadosEsperados[tipoAtual];

            if (decodedText === codigoEsperado) {
                alert(`✅ ${tipoAtual.toUpperCase()} Confirmado!`);
                passoAtual++;

                if (passoAtual >= 3) {
                    finalizarConferencia();
                } else {
                    atualizarInstrucao();
                    html5QrcodeScanner.pause();
                    setTimeout(() => html5QrcodeScanner.resume(), 1000);
                }
            } else {
                console.log(`Lido: ${decodedText} | Esperado: ${codigoEsperado}`);
                document.getElementById('feedback-msg').innerText = "❌ Código incorreto! Tente novamente.";
                document.getElementById('feedback-msg').style.color = "red";
                // Reseta mensagem após 2s
                setTimeout(() => {
                    document.getElementById('feedback-msg').innerText = "Aponte a câmera para o código de barras.";
                    document.getElementById('feedback-msg').style.color = "#666";
                }, 2000);
            }
        }

        // 5. Gerar Relatório
        function finalizarConferencia() {
            if(html5QrcodeScanner) {
                html5QrcodeScanner.stop().then(() => {
                    mudarTela('screen-success');
                    gerarRelatorioHtml();
                }).catch(err => console.error(err));
            }
        }

        function gerarRelatorioHtml() {
            const html = `
                <div class="report-item">
                    <div class="report-label">Data Criação</div>
                    <div class="report-value">${dadosEsperados.data}</div>
                </div>
                <div class="report-item">
                    <div class="report-label">Extra</div>
                    <div class="report-value">${dadosEsperados.extra}</div>
                </div>
                <div class="report-item">
                    <div class="report-label">Comercial</div>
                    <div class="report-value">${dadosEsperados.comercial}</div>
                </div>
                <div class="report-item">
                    <div class="report-label">Popular</div>
                    <div class="report-value">${dadosEsperados.popular}</div>
                </div>
                <div class="report-item" style="border:none; margin-top:20px;">
                    <div class="report-label">Status</div>
                    <div class="report-value">AUDITADO EM ${new Date().toLocaleTimeString()}</div>
                </div>
            `;
            document.getElementById('report-content').innerHTML = html;
        }

        function mudarTela(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }
    </script>
</body>
</html>